#!/usr/bin/env escript
%% vim: ft=erlang

main([]) ->
    usage();

main([IPCSocket]) ->
    main([IPCSocket, "status"]);

main([IPCSocket, "status"]) ->
    case hello_simple_client:call("zmq-ipc://" ++ IPCSocket, get_bindings, []) of
        {ok, Bindings} ->
            BindingsList = [{proplists:get_value(<<"module">>, B), proplists:get_value(<<"url">>, B)} || {B} <- Bindings],
            io:put_chars(show_table(BindingsList)),
            halt(0);
        {error, Error} ->
            io:format(standard_error, "Oops: ~p~n", [Error]),
            halt(1)
    end.

usage() ->
    io:format(standard_error, "helloctl <IPC path> <Command>~n~n"
                              "Commands:~n"
                              "    status   -- Show the list of bound servers~n", []),
    halt(255).

show_table(List) ->
    MaxWidth = lists:foldl(fun ({K, _}, Max) -> erlang:max(iolist_size(K), Max) end, 0, List),
    lists:foldr(fun ({Module, URL}, Acc) ->
                   Space = lists:duplicate(MaxWidth - iolist_size(Module), $ ),
                   [Module, Space, "   ", URL, "\n" | Acc]
                end, [], List).
